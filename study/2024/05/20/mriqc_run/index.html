<!DOCTYPE html>
<html lang="en-us">

  <head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <!--site.title site.tagline-->
  <title>
    
      [MRIQC 3] Running MRIQC: A Step-by-Step Guide using nii2dcm, Heudiconv, and MRIQC &middot; Coffee Chat
    
  </title>

  
  <link rel="canonical" href="https://alatteaday.github.io/study/2024/05/20/mriqc_run/">
  

  <link rel="stylesheet" href="https://alatteaday.github.io/public/css/poole.css">
  <link rel="stylesheet" href="https://alatteaday.github.io/public/css/syntax.css">
  <link rel="stylesheet" href="https://alatteaday.github.io/public/css/lanyon.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=PT+Serif:400,400italic,700%7CPT+Sans:400">

  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="https://alatteaday.github.io/public/favicon.ico/apple-touch-icon.png">
  <link rel="shortcut icon" href="https://alatteaday.github.io/public/favicon.ico/favicon.ico">

  <link rel="alternate" type="application/rss+xml" title="RSS" href="https://alatteaday.github.io/atom.xml">

  
</head>


  <body>

    <!-- Target for toggling the sidebar `.sidebar-checkbox` is for regular
     styles, `#sidebar-checkbox` for behavior. -->
<input type="checkbox" class="sidebar-checkbox" id="sidebar-checkbox">

<!-- Toggleable sidebar -->
<div class="sidebar" id="sidebar">
  <div class="sidebar-item">
    <p>Curation of studies, techs, ideas and a journey as a maching learning engineer</p>
  </div>

  <nav class="sidebar-nav">

    <a class="sidebar-nav-item" href="https://alatteaday.github.io/about">About</a>
    <a class="sidebar-nav-item" href="https://alatteaday.github.io/">Home</a>
    <a class="sidebar-nav-item" href="https://alatteaday.github.io/tags">Tags</a>

    

    
    
      
        <!--
        
        -->
        
      
    
      
        <!--
        
        -->
        
      
    
      
        <!--
        
          <a class="sidebar-nav-item" 
          href="https://alatteaday.github.io/about/">About</a>
        
        -->
        
      
    
      
    
      
        <!--
        
        -->
        
          <a class="sidebar-nav-item "
          href="https://alatteaday.github.io/category/error/">Dev Tips & Fixes</a>
        
      
    
      
        <!--
        
        -->
        
          <a class="sidebar-nav-item "
          href="https://alatteaday.github.io/category/papers/">Papers</a>
        
      
    
      
        <!--
        
        -->
        
          <a class="sidebar-nav-item "
          href="https://alatteaday.github.io/category/study/">Study</a>
        
      
    
      
    
      
        <!--
        
        -->
        
      
    
      
        <!--
        
        -->
        
      
    
      
        <!--
        
        -->
        
      
    
      
        <!--
        
        -->
        
      
    
      
        <!--
        
        -->
        
      
    
      
        <!--
        
        -->
        
      
    
    <!--
    <a class="sidebar-nav-item" href="/archive/v1.1.0.zip">Download</a>
    <a class="sidebar-nav-item" href="">GitHub project</a>
    <span class="sidebar-nav-item">Currently v1.1.0</span> 
    -->
  </nav>

  <div class="sidebar-item">
    <p>
      &copy; 2024. All rights reserved.
    </p>
  </div>
</div>


    <!-- Wrap is the content to shift when toggling the sidebar. We wrap the
         content to avoid any CSS collisions with our real content. -->
    <!--site.title site.tagline-->
    <div class="wrap">
      <div class="masthead">
        <div class="container" >
          <h3 class="masthead-title">
            <a href="/" title="Home">Coffee Chat</a>
            <small>Brewing AI Knowledge</small>
          </h3>
          <div class="lang-switcher">
    
    
        eng
    

    
    
        
            <a href="/ko/study/2024/05/20/mriqc_run/">kor</a>
        
    

</div>
        </div>
      </div>

      <div class="container content">
        <div class="post">
  <h1 class="post-title">[MRIQC 3] Running MRIQC: A Step-by-Step Guide using nii2dcm, Heudiconv, and MRIQC</h1>
  <p class="post-date">20 May 2024&nbsp;&nbsp;&nbsp;&nbsp;
    <!--<span class="post-date">20 May 2024</span>-->
    
      
        
          <span class="tag" data-tag="bio">
            <a href="https://alatteaday.github.io/tags/?tag=bio">
              #bio
            </a>
          </span>
        
      
        
          <span class="tag" data-tag="brainImaging">
            <a href="https://alatteaday.github.io/tags/?tag=brainImaging">
              #brainImaging
            </a>
          </span>
        
      
    
  </p>
  <style>
img {
    display: inline;
}
p {
   margin-top: 1em;
   margin-bottom: 0em;
   margin-left: 0em;
   margin-right: 0em;
}
p.a{
   margin-top: -0.5em;
   margin-bottom: -1em;
   margin-left: 0em;
   margin-right: 0em;
}
p.b{
   margin-top: 1em;
   margin-bottom: -1em;
   margin-left: 0em;
   margin-right: 0em;
}
</style>

<p>MRIQC analyzes and evaluates the quality of the input MRI images and compiles the relevant information into a report. To use MRIQC, you need MRI images stored in the <a href="https://alatteaday.github.io/ko/study/2024/05/20/bids/">BIDS</a> format. In this post, I will detail the process of running MRIQC and obtaining analysis results using DICOM files.</p>

<p><br /></p>

<h1 id="nii2dcm">nii2dcm</h1>

<p>While I used DICOM files here, NIfTI is also a common MRI file format. If you are using NIfTI files, you can use a BIDS converter that supports NIfTI or convert the NIfTI files to DICOM and then use a DICOM-supported BIDS converter. Based on my personal experience, BIDS converters that support NIfTI did not work reliably (though this might have been due to my own mistakes). You can use the <a href="https://github.com/tomaroberts/nii2dcm"><code class="language-plaintext highlighter-rouge">nii2dcm</code> library</a> to convert NIfTI files to DICOM. Refer to the code below:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>nii2dcm NIFTI_FILE_DIR OUTPUT_DIR -d MR
</code></pre></div></div>
<ul>
  <li><code class="language-plaintext highlighter-rouge">NIFTI_FILE_DIR</code>: Path to the NIfTI file you want to convert</li>
  <li><code class="language-plaintext highlighter-rouge">OUTPUT_DIR</code>: Path where the converted DICOM files will be saved</li>
</ul>

<p><br /></p>

<h1 id="heudiconv">Heudiconv</h1>

<p>I used Heudiconv as the BIDS converter. I summarized the instructions by referring to the tutorial provided on the official page. Here’s how to use it:</p>

<h2 id="installing-heudiconv">Installing Heudiconv</h2>

<p>Install via PyPI:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>pip install heudiconv
</code></pre></div></div>

<h2 id="adjusting-heuristicpy">Adjusting heuristic.py</h2>

<p>Write a code to define the rules for saving each image in the BIDS format. You can refer to or modify the <code class="language-plaintext highlighter-rouge">heuristic.py</code> file from the data repository provided in the tutorial. This file determines the modality of the input image files and creates file paths that conform to the BIDS format for each modality, saving the images accordingly. Modify the judgment criteria and save paths as necessary.</p>

<p>The function to refer to and modify is <code class="language-plaintext highlighter-rouge">infotodict()</code> in <code class="language-plaintext highlighter-rouge">heuristic.py</code>.</p>

<ul>
  <li>Identify the modality of the images to be used: T1WI, T2WI, DWI, etc.</li>
  <li>Delete or comment out the code related to unused modalities.</li>
  <li>Check the path format where the modality images will be saved and modify it if needed.</li>
  <li>Specify and modify the criteria (dimensions, current filename characteristics, etc.) in the conditional statements to distinguish each modality.</li>
</ul>

<p>The modified example code is as follows. For T1WI and DWI, the path where the images will be saved and the conditions to determine the image modality have been set.</p>

<p align="center">
   <img src="https://github.com/alatteaday/alatteaday.github.io/blob/gh-pages/post_images/2024-05-20-mriqc_run/bids_ex1.png?raw=true" style="zoom: 90%;" />
</p>

<h2 id="running-heudiconv">Running Heudiconv</h2>

<p>After installation, set the parameters and run it as follows. Heudiconv can process multiple sets of subject data, i.e., multiple bundles of DICOM files, at once.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>heudiconv --files DICOM_FILE_DIRS -o OUTPUT_DIR -f HEURISTIC.PY -s SUB_ID -ss SES_ID -c dcm2niix -b minmeta --overwrite 
</code></pre></div></div>

<ul>
  <li><code class="language-plaintext highlighter-rouge">DICOM_FILE_DIRS</code>: Input the DICOM files for multiple subjects in a globbing format (e.g., dataset/sub-001/ses-001/<em>/</em>.dcm)</li>
  <li><code class="language-plaintext highlighter-rouge">OUTPUT_DIR</code>: Path where the converted BIDS format folder will be saved</li>
  <li><code class="language-plaintext highlighter-rouge">HEURISTIC.PY</code>: Path to the <code class="language-plaintext highlighter-rouge">heuristic.py</code> file created above</li>
  <li><code class="language-plaintext highlighter-rouge">SUB_ID</code>: Subject id (e.g. 001)</li>
  <li><code class="language-plaintext highlighter-rouge">SES_ID</code>: Session id (e.g. 001)</li>
</ul>

<p>Here is an example of how to run it. Enter the following code:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>heudiconv --files data/*/*.dcm -o bids/data/ -f heuristic.py -s 0 -ss 0 -c dcm2niix -b minmeta --overwrite 
</code></pre></div></div>

<p>BIDS format folders will be created under <code class="language-plaintext highlighter-rouge">bids/data/</code> as follows:</p>

<p class="b" align="center">
   <img src="https://github.com/alatteaday/alatteaday.github.io/blob/gh-pages/post_images/2024-05-20-mriqc_run/bids_ex2.png?raw=true" style="zoom: 100%;" />
</p>

<p><br /></p>

<h1 id="mriqc">MRIQC</h1>

<p>Once the MRI images are stored in the BIDS format, they can be input into MRIQC. MRIQC can be used by downloading the package via PyPI or through a Docker container.</p>

<h2 id="with-pypi">With PyPI</h2>

<p>First, install it using the following code:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>python -m pip install -U mriqc
</code></pre></div></div>

<p>After installation, run the following code:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mriqc BIDS_ROOT_DIR OUTPUT_DIR participant --participant-label SUB_ID
</code></pre></div></div>

<ul>
  <li><code class="language-plaintext highlighter-rouge">BIDS_ROOT_DIR</code>: Root path of the BIDS format folder</li>
  <li><code class="language-plaintext highlighter-rouge">OUTPUT_DIR</code>: Path where the MRIQC results will be saved</li>
  <li><code class="language-plaintext highlighter-rouge">participant OR group</code>: If set to <code class="language-plaintext highlighter-rouge">participant</code>, MRIQC analysis results will be obtained per subject; if set to <code class="language-plaintext highlighter-rouge">group</code>, MRIQC will analyze all images under the root path.</li>
  <li><code class="language-plaintext highlighter-rouge">SUB_ID</code>: In <code class="language-plaintext highlighter-rouge">participant</code> mode, specify the subject ID for analysis by entering it in <code class="language-plaintext highlighter-rouge">--participant-label</code>. Multiple IDs can be entered at once (e.g., <code class="language-plaintext highlighter-rouge">--participant-label 001 002 003</code>).</li>
</ul>

<h2 id="with-docker">With Docker</h2>

<p>I used MRIQC through Docker. The advantage of Docker containers is that they include all dependencies needed to run the program, ensuring a consistent environment. Enter the following code to run MRIQC at the <code class="language-plaintext highlighter-rouge">participant</code> level:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker run -it --rm -v BIDS_ROOT_DIR:/data:ro -v OUTPUT_DIR:/out nipreps/mriqc:latest /data /out participant --participant_label SUB_ID [--verbose-reports]
</code></pre></div></div>

<p>Even if the <code class="language-plaintext highlighter-rouge">nipreps/mriqc</code> image is not downloaded, it will automatically download when you run the code.</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">BIDS_ROOT_DIR</code>: Root path of the BIDS format folder. This is connected to the <code class="language-plaintext highlighter-rouge">/data</code> folder inside the container using the <code class="language-plaintext highlighter-rouge">-v</code> flag. The <code class="language-plaintext highlighter-rouge">ro</code> option stands for ‘read only’, meaning the path can only be read from the local path to the container path.</li>
  <li><code class="language-plaintext highlighter-rouge">OUTPUT_DIR</code>: Path where the MRIQC results will be saved. This is connected to the <code class="language-plaintext highlighter-rouge">/out</code> folder inside the container. If you copy the contents of the <code class="language-plaintext highlighter-rouge">/out</code> folder in the container to your local machine, you will see that the results are saved in the <code class="language-plaintext highlighter-rouge">OUTPUT_DIR</code>.
    <ul>
      <li>To copy the internal container files: When running the above <code class="language-plaintext highlighter-rouge">docker run</code> command, remove the <code class="language-plaintext highlighter-rouge">--rm</code> (remove container after completion) option. After completion, execute <code class="language-plaintext highlighter-rouge">docker cp CONTAINER_NAME:FILE_PATH LOCAL_PATH</code>.</li>
    </ul>
  </li>
  <li><code class="language-plaintext highlighter-rouge">SUB_ID</code>: Subject ID. Multiple IDs can be entered.  (e.g. <code class="language-plaintext highlighter-rouge">--participant_label 001 002 003</code>)</li>
  <li><code class="language-plaintext highlighter-rouge">--verbose-reports</code> (Optional): If this flag is included, four additional plots will be reported along with the default visual report plot.</li>
</ul>

<p>After running the above code, you can check the list of Docker images and containers to see the MRIQC-related items that have been executed.</p>

<p class="b" align="center">
   <img src="https://github.com/alatteaday/alatteaday.github.io/blob/gh-pages/post_images/2024-05-20-mriqc_run/docker_ex.png?raw=true" alt="docker_ex" style="zoom: 100%;" />
</p>

<p><br /></p>

<h1 id="mriqc-results">MRIQC Results</h1>

<p class="b" align="center">
   <img src="https://github.com/alatteaday/alatteaday.github.io/blob/gh-pages/post_images/2024-05-20-mriqc_run/mriqc_ex1_1.png?raw=true" alt="mriqc_ex1_1" style="zoom: 45%;" />
</p>

<p>When the MRIQC analysis is complete, the above-mentioned files will appear under the <code class="language-plaintext highlighter-rouge">OUTPUT_DIR</code>. Among these, the analysis results are contained in the plot image files within the <code class="language-plaintext highlighter-rouge">figures</code> folder, and the JSON and HTML files named after the respective files, such as <code class="language-plaintext highlighter-rouge">sub-0_ses-0_T1w.json</code> and <code class="language-plaintext highlighter-rouge">sub-0_ses-0_T1w.html</code> in this example. The results report is generated as an HTML file based on the plot images and JSON files.</p>

<p class="b" style="width: 100%;" align="center">
  <img src="https://github.com/alatteaday/alatteaday.github.io/blob/gh-pages/post_images/2024-05-28-mriqc_report/ex1.png?raw=true" alt="ex1" style="width: 32%;" />
  <img src="https://github.com/alatteaday/alatteaday.github.io/blob/gh-pages/post_images/2024-05-28-mriqc_report/ex2.png?raw=true" alt="ex2" style="width: 32%;" />
  <img src="https://github.com/alatteaday/alatteaday.github.io/blob/gh-pages/post_images/2024-05-28-mriqc_report/ex3.png?raw=true" alt="ex3" style="width: 32%;" />
</p>
<p>By <a href="">opening the HTML file</a>, you can view a report like the one above. By <a href="https://alatteaday.github.io/ko/study/2024/05/28/mriqc_report/">interpreting the report</a> using the visualized plots and quality metric scores, you can determine the quality of the images.</p>

<p><br /></p>

<h1 id="references">References</h1>

<ul>
  <li><a href="https://github.com/tomaroberts/nii2dcm">nii2dcm Github</a></li>
  <li><a href="https://heudiconv.readthedocs.io/en/latest/">Heudiconv’s Tutorial</a></li>
  <li><a href="https://mriqc.readthedocs.io/en/latest/">MRIQC’s Documentation</a></li>
</ul>

<p><br /></p>

</div>


<div class="related">
  <h2 class="related-title">Related posts</h2>
  <ul class="related-posts">
    
      <li>
        <h3>
          <a href="/paper/2024/06/14/mriqcsurvey/">
            Summaries of papers on MRI Quality Assessment and Control&nbsp;
            <small>14 Jun 2024</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/study/2024/05/28/mriqc_report/">
            [MRIQC 4] MRIQC Report and Image Quality Metrics (IQMs)&nbsp;
            <small>28 May 2024</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/study/dev%20tips%20&%20fixes/2024/05/21/html_flask/">
            [MRIQC 3-1] Opening an HTML file using Flask&nbsp;
            <small>21 May 2024</small>
          </a>
        </h3>
      </li>
    
  </ul>
</div>


        
          <script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        TeX: {
          equationNumbers: {
            autoNumber: "AMS"
          }
        },
        tex2jax: {
        inlineMath: [ ['$', '$'] ],
        displayMath: [ ['$$$', '$$$'], ['\\[', '\\]'] ],
        processEscapes: true,
      }
    });
    MathJax.Hub.Register.MessageHook("Math Processing Error",function (message) {
          alert("Math Processing Error: "+message[1]);
        });
    MathJax.Hub.Register.MessageHook("TeX Jax - parse error",function (message) {
          alert("Math Processing Error: "+message[1]);
        });
</script>
<script type="text/javascript" async
    src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-MML-AM_CHTML">
</script>
        
      </div>
    </div>

    <label for="sidebar-checkbox" class="sidebar-toggle"></label>

    <script src='/public/js/script.js'></script>
  </body>
</html>
